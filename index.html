!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Proyecto Engels – Balance rápido (pollos)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{--ok:#16a34a;--bad:#dc2626;--bg:#f7f7fb}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg)}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 12px;font-size:20px}
  .panel{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
  .row{display:grid;gap:16px}
  @media(min-width:980px){.row{grid-template-columns:360px 1fr}}
  label{font-size:12px;color:#444;margin-bottom:6px;display:block}
  input,select,button{font:inherit}
  input[type="number"],input[type="text"],select{width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:8px}
  .btn{padding:8px 12px;border:0;border-radius:10px;background:#2563eb;color:#fff;cursor:pointer}
  .btn.out{background:#eee;color:#111}
  .btn.danger{background:#ef4444}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
  .ok{background:#e8f7ee;color:#126b36} .bad{background:#fdeaea;color:#a11212}
  table{width:100%;border-collapse:collapse;font-size:13px;background:#fff;border-radius:12px;overflow:hidden}
  th,td{padding:8px 10px;border-bottom:1px solid #f0f0f0;text-align:right;vertical-align:top}
  th:first-child,td:first-child{text-align:left}
  .hint{font-size:12px;color:#555}
  .pill{padding:6px 10px;border-radius:999px;background:#fff;border:1px solid #e5e5e5;display:inline-flex;gap:8px;align-items:center}
  .warn{background:#fff7ed;border:1px solid #fed7aa;color:#9a3412}
  .bar{height:8px;background:#eee;border-radius:999px;overflow:hidden}
  .bar>i{display:block;height:100%;background:#2563eb}
  .mini{font-size:12px;color:#666}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:20px}
  .modal .box{background:#fff;max-width:720px;width:100%;border-radius:12px;padding:16px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
  .flex{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
</style>
</head>
<body>
<div class="wrap">
  <div class="row">
    <div class="panel">
      <h1>Balance rápido – Pollo de engorde</h1>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
        <div>
          <label>Etapa</label>
          <select id="etapa">
            <option value="starter">Inicio (0–3 semanas)</option>
            <option value="grower">Crecimiento (3–6 semanas)</option>
            <option value="finisher">Finalización (6+ semanas)</option>
          </select>
        </div>
        <div>
          <label>Total a fabricar (kg)</label>
          <input id="totalKg" type="number" min="1" value="100">
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
        <div>
          <label>Buscar ingrediente</label>
          <input id="busca" type="text" placeholder="Escribe para filtrar…">
          <div id="lista" style="margin-top:8px;display:grid;gap:6px"></div>
        </div>
        <div>
          <label>Premezcla Vit-Min</label>
          <select id="premixSel">
            <option value="std">Estándar local (0,5%)</option>
            <option value="eco">Económica (0,5%)</option>
            <option value="org">Orgánica/Eco (0,5%)</option>
            <option value="pers">Personalizada (%)</option>
          </select>
          <p class="mini" id="premixNota" style="margin-top:8px">Recomendado 0,5–1,0%. No sustituye Ca/P/Na.</p>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn out" id="preset-std">Cargar fórmula Estándar</button>
        <button class="btn out" id="autocompletar">Auto-completar con Maíz</button>
        <button class="btn out" id="normalizar">Normalizar %</button>
        <button class="btn out" id="sugerir">Sugerir ajustes</button>
        <button class="btn" id="descargar">Descargar PDF</button>
        <label class="pill" style="margin-top:8px;display:inline-flex">
          <input type="checkbox" id="expert" style="margin-right:6px">
          Modo experto (sin límites)
        </label>
      </div>

      <p class="hint" style="margin-top:10px">Tip: edita los % y verás los kg y el costo. Marca “Disponible” y pon **€/kg** para mejores sugerencias.</p>
    </div>

    <div class="panel">
      <div id="estado" class="pill warn" style="margin-bottom:10px">Revisa los porcentajes…</div>
      <div class="bar" style="margin-bottom:8px"><i id="bar" style="width:0%"></i></div>
      <div class="mini">Suma de %: <span id="sumaPct">0</span>% (<span id="sumaKg">0</span> kg) · Costo estimado: € <span id="costototal">0.00</span></div>

      <div style="overflow:auto;margin-top:8px">
        <table id="tabla">
          <thead>
            <tr>
              <th>Ingrediente</th>
              <th>%</th>
              <th>Kg</th>
              <th>€/kg</th>
              <th>Disp.</th>
              <th>Energía</th>
              <th>Proteína</th>
              <th>Lisina</th>
              <th>Metionina + Cistina</th>
              <th>Calcio</th>
              <th>Fósforo disp.</th>
              <th>Sodio</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="tBody"></tbody>
        </table>
      </div>

      <h3 style="margin-top:16px">Comparación con requerimiento</h3>
      <div id="req"></div>
    </div>
  </div>
</div>

<!-- Modal sugerencias -->
<div class="modal" id="modal">
  <div class="box">
    <div class="flex" style="justify-content:space-between">
      <h3 style="margin:0">Sugerencias de ajuste</h3>
      <button class="btn danger" onclick="cerrarModal()">Cerrar</button>
    </div>
    <div id="sugBody" style="margin-top:8px"></div>
    <div style="margin-top:12px" class="flex">
      <button class="btn" id="aplicarSug">Aplicar sugerencias</button>
      <span class="mini">Se respetan límites y disponibilidad; prioriza menor costo.</span>
    </div>
  </div>
</div>

<script>
// ===== Base de ingredientes (valores típicos; editables por fila) =====
const LIB = [
 {id:'maiz', n:'Maíz amarillo', E:3350, Prot:8.5, Lys:0.26, MetCys:0.46, Ca:0.02, Pdisp:0.08, Na:0.02},
 {id:'soya44', n:'Harina de soya 44%', E:2450, Prot:44.0, Lys:2.70, MetCys:1.30, Ca:0.29, Pdisp:0.65, Na:0.02},
 {id:'pescado', n:'Harina de pescado', E:2800, Prot:60.0, Lys:5.40, MetCys:3.00, Ca:5.00, Pdisp:3.00, Na:1.50},
 {id:'aceite', n:'Aceite vegetal', E:8800, Prot:0.0, Lys:0.00, MetCys:0.00, Ca:0.00, Pdisp:0.00, Na:0.00},
 {id:'caco3', n:'Carbonato de calcio', E:0, Prot:0, Lys:0, MetCys:0, Ca:38.0, Pdisp:0.00, Na:0.00},
 {id:'fdical', n:'Fosfato dicálcico', E:0, Prot:0, Lys:0, MetCys:0, Ca:23.0, Pdisp:18.50, Na:0.00},
 {id:'sal', n:'Sal común', E:0, Prot:0, Lys:0, MetCys:0, Ca:0.00, Pdisp:0.00, Na:39.00},
 {id:'premix', n:'Premezcla vit-min', E:0, Prot:0, Lys:0, MetCys:0, Ca:0.00, Pdisp:0.00, Na:0.00}
];

// Precios de referencia (puedes cambiarlos)
const PRECIOS = {
  maiz:0.30, soya44:0.55, pescado:1.20, aceite:1.10, caco3:0.08, fdical:0.85, sal:0.10, premix:2.50
};

// ===== Requerimientos por etapa (referencia práctica) =====
const REQ = {
 starter:{Et:'Inicio', EM:2900, Prot:23.0, Lys:1.10, MetCys:0.90, Ca:1.00, Pdisp:0.45, Na:0.20},
 grower:{Et:'Crecimiento', EM:3000, Prot:21.0, Lys:1.00, MetCys:0.80, Ca:0.90, Pdisp:0.40, Na:0.18},
 finisher:{Et:'Finalización', EM:3100, Prot:19.0, Lys:0.90, MetCys:0.75, Ca:0.85, Pdisp:0.38, Na:0.16}
};

// ===== Límites por especie/etapa =====
const LIMITES = {
  pollo: {
    starter: { // 0–3 semanas
      maiz:{min:40,max:60,nota:"Energía 40–60%"},
      soya44:{min:28,max:45,nota:"Proteína 28–45%"},
      pescado:{min:0,max:6,nota:"Inicio 0–6%"},
      aceite:{min:0,max:4,nota:"Aceite 0–4%"},
      caco3:{min:0.8,max:1.5,nota:"Ca 0.8–1.5%"},
      fdical:{min:0.6,max:1.2,nota:"P disp. 0.6–1.2%"},
      sal:{min:0.25,max:0.5,nota:"Na/Cl 0.25–0.5%"},
      premix:{min:0.5,max:1.0,nota:"Vit-Min 0.5–1.0%"}
    },
    grower: { // 3–6 semanas
      maiz:{min:45,max:65,nota:"Energía 45–65%"},
      soya44:{min:24,max:40,nota:"Proteína 24–40%"},
      pescado:{min:0,max:3,nota:"Crec. 0–3%"},
      aceite:{min:0,max:5,nota:"Aceite 0–5%"},
      caco3:{min:0.7,max:1.3,nota:"Ca 0.7–1.3%"},
      fdical:{min:0.5,max:1.1,nota:"P disp. 0.5–1.1%"},
      sal:{min:0.25,max:0.5,nota:"Na/Cl 0.25–0.5%"},
      premix:{min:0.5,max:1.0,nota:"Vit-Min 0.5–1.0%"}
    },
    finisher: { // 6+ semanas
      maiz:{min:50,max:70,nota:"Energía 50–70%"},
      soya44:{min:18,max:35,nota:"Proteína 18–35%"},
      pescado:{min:0,max:1,nota:"Final 0–1%"},
      aceite:{min:0,max:5,nota:"Aceite 0–5%"},
      caco3:{min:0.6,max:1.2,nota:"Ca 0.6–1.2%"},
      fdical:{min:0.4,max:1.0,nota:"P disp. 0.4–1.0%"},
      sal:{min:0.25,max:0.5,nota:"Na/Cl 0.25–0.5%"},
      premix:{min:0.5,max:1.0,nota:"Vit-Min 0.5–1.0%"}
    }
  }
};
let especie = 'pollo';

// ===== Estado de la fórmula =====
let totalKg = 100;
let etapa = 'starter';
let filas = []; // {id, n, pct, precio, disp, vals:{...}}

function getLimitesActuales(){ return LIMITES[especie][etapa] || {}; }

// fórmula estándar
function presetStd(){
 filas = [
  addRow('maiz',55),
  addRow('soya44',36),
  addRow('pescado',4),
  addRow('aceite',2),
  addRow('caco3',1),
  addRow('fdical',0.8),
  addRow('sal',0.3),
  addRow('premix',0.5) // 0,5% por defecto
 ];
 render();
}
function addRow(id, pct=0){
 const base = LIB.find(x=>x.id===id);
 return { id:base.id, n:base.n, pct:Number(pct), precio:PRECIOS[id]??0, disp:true,
          vals:{E:base.E, Prot:base.Prot, Lys:base.Lys, MetCys:base.MetCys, Ca:base.Ca, Pdisp:base.Pdisp, Na:base.Na}};
}

// ===== UI lista ingredientes con botón Agregar =====
const lista = document.getElementById('lista');
function renderLista(filtro=''){
 lista.innerHTML='';
 LIB.filter(x=>x.n.toLowerCase().includes(filtro.toLowerCase()))
    .forEach(x=>{
      const d=document.createElement('div');
      d.className='pill';
      d.innerHTML=`<span>${x.n}</span><button class="btn" style="padding:4px 8px" onclick="agregar('${x.id}')">Agregar</button>`;
      lista.appendChild(d);
    });
}
function agregar(id){
 if(filas.some(f=>f.id===id)) return alert('Ya está en la tabla.');
 filas.push(addRow(id,0));
 render();
}

// ===== Tabla =====
const tBody=document.getElementById('tBody');
function render(){
 tBody.innerHTML='';
 const limMap = getLimitesActuales();

 filas.forEach((f,i)=>{
   const kg = (f.pct*totalKg/100);
   const lim = limMap[f.id] || {min:0, max:100, nota:""};
   const tr=document.createElement('tr');
   tr.innerHTML = `
     <td>${f.n}<div class="mini" style="color:#666">${lim.nota}</div></td>
     <td><input type="number" min="${lim.min}" max="${lim.max}" step="0.1" value="${f.pct}" style="width:80px" oninput="chgPct(${i},this.value)"></td>
     <td>${kg.toFixed(2)}</td>
     <td><input type="number" step="0.01" value="${f.precio}" style="width:90px" oninput="chgPrecio(${i},this.value)"></td>
     <td><input type="checkbox" ${f.disp?'checked':''} onclick="chgDisp(${i},this.checked)"></td>
     <td>${f.vals.E}</td>
     <td>${f.vals.Prot}</td>
     <td>${f.vals.Lys}</td>
     <td>${f.vals.MetCys}</td>
     <td>${f.vals.Ca}</td>
     <td>${f.vals.Pdisp}</td>
     <td>${f.vals.Na}</td>
     <td>
       <button class="btn out" onclick="editar(${i})">Editar valores</button>
       <button class="btn danger" onclick="quitar(${i})">Quitar</button>
     </td>`;
   tBody.appendChild(tr);
 });
 actualizarEstado();
 renderReq();
}
function chgPrecio(i,v){ filas[i].precio = Math.max(0, Number(v||0)); actualizarEstado(); }
function chgDisp(i,v){ filas[i].disp = !!v; }
function chgPct(i,v){
  const x = Number(v||0);
  const limMap = getLimitesActuales();
  const lim = limMap[filas[i].id] || {min:0,max:100};
  const expert = document.getElementById('expert')?.checked;
  if(!expert){
    if(x < lim.min){ filas[i].pct = lim.min; alert(`Mínimo ${filas[i].n}: ${lim.min}%`); render(); return; }
    if(x > lim.max){ filas[i].pct = lim.max; alert(`Máximo ${filas[i].n}: ${lim.max}%`); render(); return; }
  }
  filas[i].pct = x;
  render();
}
function quitar(i){ filas.splice(i,1); render(); }
function editar(i){
  const f=filas[i];
  const p = prompt(`Editar valores de ${f.n} (E;Prot;Lisina;Met+Cist;Ca;Pdisp;Na)\nActual: ${f.vals.E};${f.vals.Prot};${f.vals.Lys};${f.vals.MetCys};${f.vals.Ca};${f.vals.Pdisp};${f.vals.Na}`);
  if(!p) return;
  const a=p.split(';').map(x=>Number(x.trim()));
  if(a.length===7 && a.every(x=>!Number.isNaN(x))){
    [f.vals.E,f.vals.Prot,f.vals.Lys,f.vals.MetCys,f.vals.Ca,f.vals.Pdisp,f.vals.Na]=a;
    render();
  } else alert('Formato inválido. Usa 7 números separados por punto y coma.');
}

// ===== Estado % / kg / costo =====
function actualizarEstado(){
  const sumPct = filas.reduce((s,f)=>s+Number(f.pct||0),0);
  const sumKg  = sumPct*totalKg/100;
  const costo  = filas.reduce((s,f)=> s + (f.pct*totalKg/100)* (Number(f.precio)||0), 0);
  document.getElementById('sumaPct').textContent = sumPct.toFixed(2);
  document.getElementById('sumaKg').textContent  = sumKg.toFixed(2);
  document.getElementById('costototal').textContent = costo.toFixed(2);
  document.getElementById('bar').style.width = Math.min(sumPct,100)+'%';

  let msg='', cls='pill';
  if(Math.abs(sumPct-100)<0.01){ msg='✅ La mezcla suma 100%. Listo para fabricar.'; cls+=' ok'; }
  else if(sumPct<100){ 
     const falta = (100-sumPct).toFixed(2);
     const kf = ((100-sumPct)*totalKg/100).toFixed(2);
     msg = `Faltan ${falta}% (${kf} kg). Usa "Auto-completar" o ajusta manualmente.`;
     cls+=' warn';
  } else {
     const sobra = (sumPct-100).toFixed(2);
     const ks = ((sumPct-100)*totalKg/100).toFixed(2);
     msg = `Sobran ${sobra}% (${ks} kg). Reduce algún ingrediente o "Normalizar %".`;
     cls+=' warn';
  }
  const est=document.getElementById('estado');
  est.textContent = msg; est.className = cls;
}

// Autocompletar con maíz (respetando límites si no es experto)
document.getElementById('autocompletar').onclick = ()=>{
  const sumPct = filas.reduce((s,f)=>s+Number(f.pct||0),0);
  const falt = 100 - sumPct;
  if(falt<=0) return render();
  let maiz = filas.find(f=>f.id==='maiz');
  if(!maiz){ maiz = addRow('maiz',0); filas.push(maiz); }
  const expert = document.getElementById('expert')?.checked;
  if(!expert){
    const lim = getLimitesActuales().maiz || {min:0,max:100};
    const posible = Math.min(falt, Math.max(0, lim.max - (maiz.pct||0)));
    maiz.pct += posible;
  } else maiz.pct += falt;
  render();
};
// Normalizar %
document.getElementById('normalizar').onclick = ()=>{
  const sumPct = filas.reduce((s,f)=>s+Number(f.pct||0),0);
  if(sumPct<=0) return;
  filas.forEach(f=>f.pct = f.pct*100/sumPct);
  render();
};

// ===== Premix selector =====
document.getElementById('premixSel').addEventListener('change', e=>{
  const v = e.target.value;
  const premix = filas.find(f=>f.id==='premix') || addRow('premix',0);
  if(!filas.find(f=>f.id==='premix')) filas.push(premix);
  const lims = getLimitesActuales().premix || {min:0.5,max:1.0};
  let nota = "Recomendado 0,5–1,0%. No sustituye Ca/P/Na.";
  if(v==='pers'){
    nota = "Personaliza el % (respetando 0,5–1,0% salvo Modo experto).";
  } else {
    premix.pct = Math.min(lims.max, Math.max(lims.min, 0.5));
  }
  document.getElementById('premixNota').textContent = nota;
  render();
});

// ===== Cálculo de aporte y comparación =====
function aporte(){
  const E   = sumBy(f=>f.vals.E);
  const Prot= sumBy(f=>f.vals.Prot);
  const Lys = sumBy(f=>f.vals.Lys);
  const MC  = sumBy(f=>f.vals.MetCys);
  const Ca  = sumBy(f=>f.vals.Ca);
  const Pd  = sumBy(f=>f.vals.Pdisp);
  const Na  = sumBy(f=>f.vals.Na);
  return {E,Prot,Lys,MC,Ca,Pd,Na};
  function sumBy(sel){
    const sumPct = filas.reduce((s,f)=>s+Number(f.pct||0),0)||1;
    return filas.reduce((s,f)=>s + (Number(f.pct||0)/100)*sel(f), 0) * (100/sumPct);
  }
}
function renderReq(){
  const r = REQ[etapa];
  const a = aporte();
  const html = `
    <div class="panel" style="padding:10px;margin-top:8px">
      ${cmp('Energía metabolizable (kcal/kg)', r.EM, a.E, v=>v>=r.EM, true)}
      ${cmp('Proteína cruda (%)', r.Prot, a.Prot, v=>v>=r.Prot)}
      ${cmp('Lisina (%)', r.Lys, a.Lys, v=>v>=r.Lys)}
      ${cmp('Metionina + Cistina (%)', r.MetCys, a.MC, v=>v>=r.MetCys)}
      ${cmp('Calcio (%)', r.Ca, a.Ca, v=>v>=r.Ca)}
      ${cmp('Fósforo disponible (%)', r.Pdisp, a.Pd, v=>v>=r.Pdisp)}
      ${cmp('Sodio (%)', r.Na, a.Na, v=>v>=r.Na)}
    </div>`;
  document.getElementById('req').innerHTML = html;

  function cmp(nombre, req, ap, okfn, isEnergy){
    const ok = okfn(ap);
    return `
      <div style="display:grid;grid-template-columns:1fr 130px 140px 90px;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid #f1f1f1">
        <div>${nombre}</div>
        <div class="mini"><b>Requerido</b><br>${req.toFixed(isEnergy?0:2)} ${isEnergy?'kcal/kg':'%'}</div>
        <div class="mini"><b>Aporte fórmula</b><br>${ap.toFixed(isEnergy?0:2)} ${isEnergy?'kcal/kg':'%'}</div>
        <div><span class="tag ${ok?'ok':'bad'}">${ok?'Cumple':'No cumple'}</span></div>
      </div>`;
  }
}

// ===== Sugerencias (disponibilidad + precio + límites) =====
const modal = document.getElementById('modal');
const sugBody = document.getElementById('sugBody');
let sugerenciasAplicables = null;

document.getElementById('sugerir').onclick = ()=>{
  const r = REQ[etapa], a = aporte();
  const deficits = [];
  if(a.E < r.EM) deficits.push({k:'E', nombre:'Energía (kcal/kg)', falta:r.EM - a.E});
  if(a.Prot < r.Prot) deficits.push({k:'Prot', nombre:'Proteína (%)', falta:r.Prot - a.Prot});
  if(a.Lys < r.Lys) deficits.push({k:'Lys', nombre:'Lisina (%)', falta:r.Lys - a.Lys});
  if(a.MC < r.MetCys) deficits.push({k:'MC', nombre:'Metionina + Cistina (%)', falta:r.MetCys - a.MC});
  if(a.Ca < r.Ca) deficits.push({k:'Ca', nombre:'Calcio (%)', falta:r.Ca - a.Ca});
  if(a.Pd < r.Pdisp) deficits.push({k:'Pd', nombre:'Fósforo disp. (%)', falta:r.Pdisp - a.Pd});
  if(a.Na < r.Na) deficits.push({k:'Na', nombre:'Sodio (%)', falta:r.Na - a.Na});

  let txt = '';
  sugerenciasAplicables = [];

  const limMap = getLimitesActuales();
  const expert = document.getElementById('expert')?.checked;

  function room(f){
    const lim = limMap[f.id] || {min:0,max:100};
    return expert ? Infinity : Math.max(0, lim.max - (f.pct||0));
  }
  function addSug(id, deltaPct){
    if(deltaPct<=0) return;
    sugerenciasAplicables.push({id, deltaPct});
  }

  // candidatos ordenados por €/kg (asc) y disponibilidad
  const cand = (ids)=> ids.map(id=>filas.find(f=>f.id===id)).filter(f=>f && f.disp).sort((a,b)=>(a.precio||0)-(b.precio||0));

  deficits.forEach(d=>{
    if(d.k==='E'){
      // energía: maíz, aceite
      let falt = d.falta;
      const lista = cand(['maiz','aceite']);
      lista.forEach(f=>{
        if(falt<=0) return;
        // conversión aproximada: subir 1% maíz ≈ +33.5 kcal/kg (aprox sobre base 100); aceite ≈ +88 kcal/kg
        const gainPerPct = (f.id==='aceite') ? 88 : 33.5;
        const needPct = Math.min(room(f), Math.ceil((falt/gainPerPct)*10)/10);
        if(needPct>0){ addSug(f.id, needPct); falt -= needPct*gainPerPct; }
      });
      if(falt>0) txt += `<p>• Energía: falta ≈ ${falt.toFixed(0)} kcal/kg aún; revisa límites o activa Modo experto.</p>`;
    }
    if(d.k==='Prot' || d.k==='Lys' || d.k==='MC'){
      // proteína/aa: soya (barata), pescado (inicio, más caro)
      let falt = d.falta;
      const lista = cand(['soya44','pescado']);
      lista.forEach(f=>{
        if(falt<=0) return;
        const gainPerPct = (d.k==='Prot') ? f.vals.Prot/100 : (d.k==='Lys'? f.vals.Lys/100 : f.vals.MetCys/100);
        // aproximación: subir 1% del ingrediente aporta gainPerPct puntos %
        const needPct = gainPerPct>0 ? Math.min(room(f), Math.ceil((falt/gainPerPct)*10)/10) : 0;
        if(needPct>0){ addSug(f.id, needPct); falt -= needPct*gainPerPct; }
      });
      if(falt>0) txt += `<p>• ${d.nombre}: aún faltan ≈ ${falt.toFixed(3)} %. Considera otro proteico o activa Modo experto.</p>`;
    }
    if(d.k==='Ca'){
      let falt = d.falta;
      const lista = cand(['caco3','fdical']);
      lista.forEach(f=>{
        if(falt<=0) return;
        const gainPerPct = f.vals.Ca/100;
        const needPct = Math.min(room(f), Math.ceil((falt/gainPerPct)*10)/10);
        if(needPct>0){ addSug(f.id, needPct); falt -= needPct*gainPerPct; }
      });
      if(falt>0) txt += `<p>• Calcio: aún faltan ≈ ${falt.toFixed(3)} %.</p>`;
    }
    if(d.k==='Pd'){
      let falt = d.falta;
      const lista = cand(['fdical']);
      lista.forEach(f=>{
        if(falt<=0) return;
        const needPct = Math.min(room(f), Math.ceil((falt/(f.vals.Pdisp/100))*10)/10);
        if(needPct>0){ addSug(f.id, needPct); falt -= needPct*(f.vals.Pdisp/100); }
      });
      if(falt>0) txt += `<p>• Fósforo disp.: aún faltan ≈ ${falt.toFixed(3)} % (revisa fosfatos).</p>`;
    }
    if(d.k==='Na'){
      let falt = d.falta;
      const lista = cand(['sal']);
      lista.forEach(f=>{
        if(falt<=0) return;
        const needPct = Math.min(room(f), Math.ceil((falt/(f.vals.Na/100))*10)/10);
        if(needPct>0){ addSug(f.id, needPct); falt -= needPct*(f.vals.Na/100); }
      });
      if(falt>0) txt += `<p>• Sodio: aún faltan ≈ ${falt.toFixed(3)} %.</p>`;
    }
  });

  // construir lista legible
  let acc = {};
  sugerenciasAplicables.forEach(s=>{ acc[s.id]=(acc[s.id]||0)+s.deltaPct; });
  let lines = Object.entries(acc).map(([id,dp])=>{
    const f = filas.find(x=>x.id===id);
    const kg = (dp*totalKg/100);
    return `<li>Subir <b>${f.n}</b> en <b>${dp.toFixed(1)} %</b> (~${kg.toFixed(2)} kg) · €/${(f.precio||0).toFixed(2)}/kg</li>`;
  });
  if(lines.length===0 && deficits.length===0){
    sugBody.innerHTML = `<p>✅ Todo cumple. No hay ajustes necesarios.</p>`;
  }else{
    sugBody.innerHTML = (lines.length? `<ul>${lines.join('')}</ul>` : `<p>No hubo candidatos disponibles o límites alcanzados.</p>`) + (txt?`<div class="mini" style="margin-top:8px">${txt}</div>`:'');
  }
  modal.style.display='flex';
};
function cerrarModal(){ modal.style.display='none'; }
document.getElementById('aplicarSug').onclick = ()=>{
  if(!sugerenciasAplicables || !sugerenciasAplicables.length) return cerrarModal();
  const limMap = getLimitesActuales();
  const expert = document.getElementById('expert')?.checked;
  sugerenciasAplicables.forEach(s=>{
    const f = filas.find(x=>x.id===s.id); if(!f) return;
    const lim = limMap[f.id] || {min:0,max:100};
    const to = expert ? f.pct + s.deltaPct : Math.min(lim.max, f.pct + s.deltaPct);
    f.pct = to;
  });
  cerrarModal();
  render();
};

// ===== Eventos =====
document.getElementById('totalKg').addEventListener('input',e=>{
 totalKg = Math.max(1, Number(e.target.value||100)); render();
});
document.getElementById('etapa').addEventListener('change',e=>{
 etapa = e.target.value;
 render(); // refresca límites y tabla
});
document.getElementById('busca').addEventListener('input',e=>{
 renderLista(e.target.value);
});
document.getElementById('preset-std').onclick = presetStd;

// PDF (impresión del navegador)
document.getElementById('descargar').onclick = ()=> window.print();

// Init
renderLista('');
presetStd();
</script>
</body>
</html>
